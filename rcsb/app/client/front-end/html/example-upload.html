<!DOCTYPE html>
<html lang="en">
	<head>
        <meta charset="UTF-8">
        <title>HTML UPLOAD EXAMPLE</title>
        <!-- author James Smith j-s-135 -->
        <script src = "http://www.myersdaily.org/joseph/javascript/md5.js"></script>
		<script type="text/javascript">
			handleform = async () => {
              window.event.preventDefault();
              let base_url = "http://0.0.0.0:8000";
              let upload_parameters_url = `${base_url}/file-v2/getSaveFilePath/`;
              let upload_id_url = `${base_url}/file-v2/getNewUploadId/`;
              let sequential_chunk_url = `${base_url}/file-v2/upload/`;
              let jwt_token = '';
              let file = document.getElementsByName('uploadFile')[0].files[0];
              let fileName = file.name;
              console.log(`file name ${file.name} modified ${file.lastModified} size ${file.size}`);
              // hash file
              // if file is a zip file, file has been compressed before hashing/upload
              let hashDigest = null;
              await getHashDigest(file);
              // get server-side parameters
              let filePath = null;
              await getSaveFilePath();
              if(! filePath){
                  console.log('error - could not read file path, or target file may already exist');
                  return;
              }
              // get client-side parameters
              let chunkIndex = 0;
              let uploadId = null;
              await getUploadStatus();
              if(! uploadId){
                  await getNewUploadId();
                  if (! uploadId){
                      console.log('error - no upload id');
                      return;
                  }
              }
              // start upload
              upload(file);

              async function getHashDigest(file){
                var reader = new FileReader();
                reader.readAsBinaryString(file);
                reader.onloadend = await function () {
                    hashDigest = md5(reader.result);
                    console.log('md5 hash = ' + hashDigest);
                }
              }

              async function getSaveFilePath() {
                let repositoryType = document.getElementsByName('repositoryType')[0].value;
                let depId = document.getElementsByName('depId')[0].value;
                let contentType = document.getElementsByName('contentType')[0].value;
                let milestone = document.getElementsByName('milestone')[0].value;
                let partNumber = document.getElementsByName('partNumber')[0].value;
                let contentFormat = document.getElementsByName('contentFormat')[0].value;
                let version = document.getElementsByName('version')[0].value;
                let allowOverwrite = document.getElementsByName('allowOverwrite')[0].checked;
                let query = `?repositoryType=${repositoryType}&depId=${depId}&contentType=${contentType}&milestone=${milestone}&partNumber=${partNumber}&contentFormat=${contentFormat}&version=${version}&allowOverwrite=${allowOverwrite}`
                let url = upload_parameters_url + query
                await fetch(url, {
                    method: "GET",
                    headers: {"Authorization": `Bearer ${jwt_token}`}
                }).then(data => data.json()).then(json => {filePath = json.filePath;}).catch(err => console.log(err));
              }

              async function getUploadStatus(){
                  let resumable = document.getElementsByName('resumable')[0].checked;
                  if(! resumable){
                      console.log('not a resumable upload');
                      return;
                  }
                  if(typeof(Storage) !== 'undefined') {
                      if(localStorage.uploadId && localStorage.uploadCount){
                          uploadId = localStorage.getItem('uploadId');
                          chunkIndex = Number(localStorage.getItem('uploadCount'));
                          console.log(`detected previous upload having ${chunkIndex} chunks with id ${uploadId}`);
                      } else {
                          console.log('no previous upload was detected');
                      }
                  } else {
                      console.log('error - browser does not have local storage');
                  }
              }

              async function getNewUploadId(){
                  let url = upload_id_url;
                  await fetch(url, {
                      method: "GET",
                      headers: {"Authorization": `Bearer ${jwt_token}`}
                  }).then(data => data.json()).then(json => {uploadId = json.uploadId}).catch(err => console.log(err));
              }

              async function upload(file){
                var fileSize = file.size;
                var chunkSize = 1024 * 1024 * 8; // bytes
                var expectedChunks = Math.ceil((fileSize) / chunkSize);
                var chunkOffset = chunkIndex * chunkSize;
                var hashType = "MD5";
                let decompress = document.getElementsByName('decompress')[0].checked;
                let allowOverwrite = document.getElementsByName('allowOverwrite')[0].checked;
                let resumable = document.getElementsByName('resumable')[0].checked;
                console.log(`chunk index ${chunkIndex} expected ${expectedChunks} for ${fileName} ${uploadId} ${filePath}`)
                readChunks(chunkIndex, chunkOffset);

                function readChunks(chunkIndex, chunkOffset) {
                  if (chunkIndex >= expectedChunks) {
                      // cleanup
                      console.log('clearing database');
                      localStorage.removeItem('uploadId');
                      localStorage.removeItem('uploadCount');
                      return;
                  }
                  if(resumable) {
                      localStorage.setItem('uploadId', uploadId);
                      localStorage.setItem('uploadCount', chunkIndex);
                  }
                    // remove comments (then re-comment) to test resumable upload
                    // if(chunkIndex >= 3){
                    //     return;
                    // }
                  console.log(`posting chunk ${chunkIndex} of ${expectedChunks}`);
                  var blob = file.slice(chunkOffset, chunkOffset + chunkSize);
                  postChunk(blob);
                }

                async function postChunk(blob) {
                  var chunk = blob;
                  console.log(`size of upload file = ${blob.size}`)
                  if (blob.size <= 0) {
                    return;
                  }
                  formdata = new FormData();
                  // chunk parameters
                  formdata.append("chunk", chunk);
                  formdata.append("chunkSize", chunkSize);
                  formdata.append("chunkIndex", chunkIndex);
                  formdata.append("expectedChunks", expectedChunks);
                  // upload file parameters
                  formdata.append("uploadId", uploadId);
                  formdata.append("hashType", hashType);
                  formdata.append("hashDigest", hashDigest);
                  // formdata.append("resumable", resumable);
                  // save file parameters
                  formdata.append("filePath", filePath);
                  formdata.append("decompress", decompress);
                  formdata.append("allowOverwrite", allowOverwrite);
                  fetch(sequential_chunk_url, {
                    method: "POST",
                    headers: {"Authorization": `Bearer ${jwt_token}`},
                    body: formdata
                  }).then(() => {
                    chunkOffset += chunkSize;
                    chunkIndex = chunkIndex + 1;
                    readChunks(chunkIndex, chunkOffset);
                  })
                }
              }

            }
        </script>
		<style>
			div {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
			form {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				row-gap: 5px;
				border: 1px solid black;
				padding: 20px;
			}
		</style>
	</head>
	<body>
		<div>
		<form action="http://0.0.0.0:8000/file-v2/upload" method="POST" enctype="multipart/form-data" onsubmit="return handleform();">
			<label>Upload file</label>
			<input type="file" name="uploadFile">
            <label>Repository type</label>
            <input type="text" name="repositoryType">
            <label>Deposit id</label>
            <input type="text" name="depId">
            <label>Content type</label>
            <input type="text" name="contentType">
            <label>Milestone</label>
            <input type="text" name="milestone">
            <label>Part number</label>
            <input type="text" name="partNumber">
            <label>Content format</label>
            <input type="text" name="contentFormat">
            <label>Version</label>
            <input type="text" name="version">

            <table>
                <tr>
                    <td>
                        <input type="checkbox" name="allowOverwrite">
                    </td>
                    <td>
                         <label>Overwrite</label>
                    </td>
                </tr>
                <tr>
                    <td>
                         <input type="checkbox" name="decompress">
                    </td>
                    <td>
                         <label>Decompress zip file after upload</label>
                    </td>
                </tr>
                <tr>
                    <td>
                         <input type="checkbox" name="resumable">
                    </td>
                    <td>
                         <label>Resumable upload</label>
                    </td>
                </tr>
            </table>

            <input type="submit" value="submit">
            <input type="reset" value="reset">
		</form>
		</div>
	</body>
</html>