<!DOCTYPE html>
<html lang="en">
	<head>
        <meta charset="UTF-8">
        <title>HTML UPLOAD EXAMPLE</title>
        <!-- author James Smith -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
        <script src = "http://www.myersdaily.org/joseph/javascript/md5.js"></script>
		<script type="text/javascript">
            $(document).ready(function(){
                $('form').bind("submit", async function() {
                    window.event.preventDefault();
                    let base_url = "http://0.0.0.0:8000";
                    let upload_parameters_url = `${base_url}/file-v2/getUploadParameters/`;
                    let sequential_chunk_url = `${base_url}/file-v2/upload/`;
                    let file = document.getElementsByName('uploadFile')[0].files[0];
                    let fileName = file.name;
                    console.log(`file name ${file.name} modified ${file.lastModified} size ${file.size}`);
                    // hash file
                    // if file is a zip file, file has been compressed before hashing/upload
                    let hashDigest = null;
                    await getHashDigest(file);
                    // get upload parameters
                    let uploadId = null;
                    let filePath = null;
                    let chunkIndex = 0;
                    await getUploadParameters();
                    if (!uploadId || !filePath) {
                        console.log('error - could not read file path, or target file may already exist');
                        return;
                    }
                    // start upload
                    upload(file);

                    async function getHashDigest(file) {
                        var reader = new FileReader();
                        reader.readAsBinaryString(file);
                        reader.onloadend = await function () {
                            hashDigest = md5(reader.result);
                            console.log('md5 hash = ' + hashDigest);
                        }
                    }

                    async function getUploadParameters() {
                        let repositoryType = document.getElementsByName('repositoryType')[0].value;
                        let depId = document.getElementsByName('depId')[0].value;
                        let contentType = document.getElementsByName('contentType')[0].value;
                        let milestone = document.getElementsByName('milestone')[0].value;
                        let partNumber = document.getElementsByName('partNumber')[0].value;
                        let contentFormat = document.getElementsByName('contentFormat')[0].value;
                        let version = document.getElementsByName('version')[0].value;
                        let allowOverwrite = document.getElementsByName('allowOverwrite')[0].checked;
                        let query = `?repositoryType=${repositoryType}&depId=${depId}&contentType=${contentType}&milestone=${milestone}&partNumber=${partNumber}&contentFormat=${contentFormat}&version=${version}&allowOverwrite=${allowOverwrite}`
                        let url = upload_parameters_url + query

                        await $.ajax({
                            url: url,
                            type: 'GET',
                            dataType: 'html',
                            headers: {"Authorization": "Bearer jwtDisable"},
                            complete: function(data, status){
                                json = JSON.parse(data.responseText);
                                filePath = json.filePath;
                                chunkIndex = json.chunkIndex;
                                uploadId = json.uploadId;
                            },
                            error: function(xhr, status, err){
                                console.log(err);
                            }
                        })

                    }

                    async function upload(file) {
                        var fileSize = file.size;
                        var chunkSize = 1024 * 1024 * 8; // bytes
                        var expectedChunks = Math.ceil((fileSize) / chunkSize);
                        var chunkOffset = chunkIndex * chunkSize;
                        var hashType = "MD5";
                        let decompress = document.getElementsByName('decompress')[0].checked;
                        let allowOverwrite = document.getElementsByName('allowOverwrite')[0].checked;
                        let resumable = document.getElementsByName('resumable')[0].checked;
                        console.log(`${fileName} ${uploadId} ${filePath}`)
                        readChunks(chunkIndex, chunkOffset);

                        function readChunks(chunkIndex, chunkOffset) {
                            if (chunkIndex >= expectedChunks) {
                                return;
                            }
                            var blob = file.slice(chunkOffset, chunkOffset + chunkSize);
                            postChunk(blob);
                        }

                        async function postChunk(blob) {
                            var chunk = blob;
                            console.log(`size of upload file = ${blob.size}`)
                            if (blob.size <= 0) {
                                return;
                            }
                            formdata = new FormData();
                            // chunk parameters
                            formdata.append("chunk", chunk);
                            formdata.append("chunkSize", chunkSize);
                            formdata.append("chunkIndex", chunkIndex);
                            formdata.append("expectedChunks", expectedChunks);
                            // upload file parameters
                            formdata.append("uploadId", uploadId);
                            formdata.append("hashType", hashType);
                            formdata.append("hashDigest", hashDigest);
                            formdata.append("resumable", resumable);
                            // save file parameters
                            formdata.append("filePath", filePath);
                            formdata.append("decompress", decompress);
                            formdata.append("allowOverwrite", allowOverwrite);

                            await $.ajax({
                                url: sequential_chunk_url,
                                type: 'POST',
                                data: formdata,
                                headers: {"Authorization": "Bearer jwtDisable"},
                                processData: false,
                                contentType: false,
                                success: function(xhr){
                                    chunkOffset += chunkSize;
                                    chunkIndex = chunkIndex + 1;
                                    readChunks(chunkIndex, chunkOffset);
                                }
                            })

                        }
                    }
                })
            })
        </script>
		<style>
			div {
				display: flex;
				flex-direction: column;
				align-items: center;
			}
			form {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				row-gap: 5px;
				border: 1px solid black;
				padding: 20px;
			}
		</style>
	</head>
	<body>
		<div>
		<form>
			<label>Upload file</label>
			<input type="file" name="uploadFile">
            <label>Repository type</label>
            <input type="text" name="repositoryType">
            <label>Deposit id</label>
            <input type="text" name="depId">
            <label>Content type</label>
            <input type="text" name="contentType">
            <label>Milestone</label>
            <input type="text" name="milestone">
            <label>Part number</label>
            <input type="text" name="partNumber">
            <label>Content format</label>
            <input type="text" name="contentFormat">
            <label>Version</label>
            <input type="text" name="version">

            <table>
                <tr>
                    <td>
                        <input type="checkbox" name="allowOverwrite">
                    </td>
                    <td>
                         <label>Overwrite</label>
                    </td>
                </tr>
                <tr>
                    <td>
                         <input type="checkbox" name="decompress">
                    </td>
                    <td>
                         <label>Decompress zip file after upload</label>
                    </td>
                </tr>
                <tr>
                    <td>
                         <input type="checkbox" name="resumable">
                    </td>
                    <td>
                         <label>Resumable upload</label>
                    </td>
                </tr>
            </table>

            <input type="submit" value="submit">
            <input type="reset" value="reset">
		</form>
		</div>
	</body>
</html>